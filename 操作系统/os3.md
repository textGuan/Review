> 计算机操作系统
>
> 教材《计算机操作系统（第四版）》 汤小丹等
>
> PPT 四川大学 杜中军老师
>
> Find more on github.com/textGuan/Review

# 第三章 进程的同步和通讯

熟悉进程间制约关系，掌握临界资源和临界区概念，掌握进程同步和进程同步机制，熟悉利用软件方法和硬件技术解决进程同步机制。熟练掌握信号量和P、V操作的概念、定义和实质，熟练掌握利用信号量实现进程互斥和同步，熟悉用信号量描述前趋关系。掌握利用信号量解生产者-消费者问题、熟悉利用信号量解读者-写者问题等经典同步问题，掌握进程同步分析方法。了解用AND型信号集机制、一般信号集机制和管程解经典同步问题。熟悉进程通讯的概念和共享存储器系统、消息传送系统、管道通信系统三类高级通讯机制，掌握消息缓冲队列通信机制。

## 3.1 进程同步

### 3.1.1 进程同步的概念

**1 进程间制约关系**

在多道程序环境中，系统中各进程以不可预测的速度向前推进，进程的异步性造成了结果的不可再现性。为防止这种现象，异步的进程间推进受到二种限制：

**资源共享关系：**多进程共享资源，每次只允许一个进程使用一段时间资源，待该进程使用完毕后再将资源分配给其

```
进程之间竞争资源面临三个控制问题
互斥、死锁、饥饿
```

**相互合作关系：**

某些进程之间存在合作关系，进程再并发执行时推进序列受到限制，要保证其合作关系正确，进程间这种关系称为同步关系。

**2临界资源和临界区**

**临界资源：**

一次只允许一个进程使用的资源称为临界资源，又称作独享资源。

允许进程间共享，即可交替使用的资源称为共享资源

**临界区：**

访问临界资源的那段代码称为临界区

**3 进程同步机制**

多个相关进程在执行次序上的协调称为进程同步。用于保证多个进程在执行次序上的协调关系的相迎机制称为进程同步机制。所有的进程同步机制都遵循以下四条准则：

**空闲让进：**

当无进程进入临界区时，相应的临界资源处于空闲状态，因而允许一个请求进入临界区的进程立即进入自己的临界区

**忙则等待：**

当已有进程进入自己的临界区时，即相应的临界资源正被访问，因而其他试图进入临界区的进程必须等待，以保证进程互斥地访问临界资源

**有限等待：**

对要求访问临界资源的进程，应保证进程能在有限时间进入临界区，以免陷入“饥饿”状态

**让权等待：**

当进程不能进入自己的临界区时，应立即释放处理机，以免陷入进程忙等 

进程同步机制在临界区前加上进入区，以检查临界资源状态，决定是允许该进程进入临界区还是等待；在临界区之后加上退出区，负责释放临界资源以便其他等待该临界资源的进程使用。

实现进程互斥和同步的信号量机制有软件方法、硬件指令方法、信号量机制和管程等。

 

### 3.1.2 利用硬件技术实现进程同步机制

提高临界区代码执行中断优先级

检测和设置（TS）硬件指令

 

## 3.2 信号量（semaphores）机制

在信号量机制中信号量是代表资源物理实体的数据结构

### 3.2.1 记录型信号机制

记录型信号量的数据结构描述如下：

```
Type semaphore=record
	Value：integer;
	L：pointer of PCB;
End
```

信号量的值只能通过两个原子操作：P、V操作来改变，它代表分配资源和释放资源

### 3.2.2 信号量的类型

信号量按联系进程的关系分成两类：

**公用信号量（互斥信号量）：**

为一组需互斥共享临界资源的并发进程而设置，代表共享的临界资源，每个进程都可对他施加PV操作（都可申请和释放该临界资源），其初始值置1。信号量取值意义如下：

```
       Mutex.value >=m，m＞0，表示m个某类资源空闲，可供使用
					=0；资源被占用，无其他进程等待
					=-n，n＞0；资源已被占用，还有n个进程因等待资源而阻塞
```

**专用信号量：**

为一组需同步协作完成任务的并发进程而设置，只有拥有该资源的进程才能对他施加P操作（申请资源），由其合作进程对他施加V操作（释放资源）

**利用信号量实现进程互斥：**

为了使多个进程能够互斥地访问某临界资源，只需为该资源设置一个互斥信号量mutex，并设其初值为1.然后将各进程的临界区CS置于P（mutex）和V（mutex）操作之间即可。

**利用信号量实现进程同步**：

设置一个同步信号量full，其代表的资源是缓冲器满，初值为0。另设置一个同步信号量empty，其代表的资源是缓冲器空，初值为1，两个信号量分别为两个进程所有，只能对自己进程施加P操作并对合作进程施加V操作。

**利用信号量描述前驱关系**

可设置同步信号量full，为后继进程所有，初值为0

 

## 3.3 利用信号量解经典进程同步问题

**生产者-消费者问题：**

只有在缓冲池中至少有一个缓冲区已存入消息后，消费者才能从中提取消息，否则消费者只能等待。

只有在缓冲区中至少有一个缓冲区是空时，生产者才能把消息放入缓冲区，否则生产者必须等待。

设置初值为0同步信号量full，代表缓冲池满，为消费者进程所有（可以申请该资源并施加P操作），设置初值为0同步信号量empty，代表缓冲池空，为生产者进程所有

**读者写者问题**

设置互斥信号量wmutex表示写者间、读者和写者间互斥

对于读者计数变量readcount，由于其属于临界资源，因此为其设置互斥信号量rmutex

 

## 3.4 经典进程同步问题的其他方法解

### 3.4.1 AND型/一般信号集机制

定义：为解决一个进程一次同时能申请几类临界资源，引入AND型信号量集机制（申请一个）；为了对每类资源又能同时申请几个，又扩充AND型信号量集机制，形成一般信号量集机制，其相应Swait、Ssignal操作如下：

```
Swait（S1，t1，d1，……，Sn，tn，dn）
If S1>=t1 and …… and Sn>=tn  then
	For I：= 1 to n do S1=S1-d1；
Endfor
Endif
else
   Place the executing process in the waiting queue of the first Si with Si< t i  and set its   program counter to the beginning of the the Swait operation. 

Ssignal(S1 ,d 1 ,  …, Sn , d n )
for i:=1 to n  do     Si = Si  + d i  ;
  Remove all the process waiting  in the queue associated with  Si  into the ready queue.
Endfor
```

 

### 3.4.2 管程

管程由一些共享数据、能为并发进程所执行的作用在共享数据上的操作的集合、初始代码以及存取权组成，用类程管理独立资源，用管程管理共享资源

 

## 3.5 进程通信

### 3.5.1 共享存储器系统

**基于共享数据结构的通信方式**

各个进程供用某个数据结构，进程通过他们交换信息。该通信方式是低效的，只适用于传送少量的数据

**基于共享存储区的通信方式**

通信速度最高的一种通信机制，包含在进程通信软件包IPC中。系统调用shmget建立一个共享存储区，返回该表项的描述符shmid。

系统调用shmat将共享存储区附接到各自进程的虚地址空间上

系统调用shmctl对共享存储区的状态信息（如长度、当前连接的进程数等）进行读取，也可设置和改变共享存储区的属性（如共享存储区的许可权等）。最后仍可利用系统调用shmctl断开进程与共享存储区的连接

 

### 3.5.2 消息传递系统

**直接通信方式**

发送进程利用OS提供的发送命令直接把消息发送给接受进程，并将它挂在接受进程的消息缓冲队列上。接收进程利用OS提供的接收命令直接从消息缓冲队列中取得消息。

要求发送进程和接收进程以显式的方式提供对方的标识符，系统提供send（receiver，message）、receive（sender，message）两条原语或（receive（message））直接通信的实例-消息缓冲队列通信机制。

系统管理一组缓冲区，每个缓冲区存放一个消息，当发送进程要发送消息时先要向系统申请一个缓冲区，然后把消息写进去，接着把该缓冲区连接到接收进程的消息缓冲队列中。接收进程可以在适当的时候从消息缓冲队列中摘下消息缓冲区，读取消息，并释放该缓冲区。

消息缓冲区数据结构表述如下：

```
type message buffer=record
	sender：发送消息的标识符
	size：消息长度
	text：消息正文
	next：指向下一个消息缓冲区的指针
end
```

**间接通信方式**

消息不直接从发送者到接收者，而是发送到暂存消息的共享数据结构组成的队列，该实体称为信箱。两个进程一个发送一个消息到某个信箱，另一个进程从信箱中摘取消息。增加了使用消息的灵活性，发送者与接收者之间的关系可以是n对n。

 

**Unix系统消息机制**

消息机制的数据结构

```
 分为消息首部和消息数据两部分
```

消息首部：消息首部中记录有消息的类型、大小、指向消息数据区的指针、消息队列的链接指针等

 

### 3.5.3 管道通信

借助于一个特殊的共享文件连接发送进程和接收进程，发送进程向管道写入信息，接收进程从管道读取信息。具有以下特点：

```
在通信前需要创建管道，管道不再使用时为了回收资源，系统可以删除管道
利用管道通信的进程双方需要同步
```


> 计算机操作系统 
>
> 教材《计算机操作系统（第四版）》 汤小丹等
>
> PPT 四川大学 杜中军老师
>
> Find more on github.com/textGuan/Review

# 第八章 文件系统

掌握文件和文件系统的定义，了解文件系统的类型、文件系统模型和操作系统(Windows98/NT 、Linux )对多种文件系统的支持。

掌握文件的逻辑结构，熟悉五种记录文件,掌握文件的物理结构。

掌握文件控制块和多级目录结构，掌握UNIX树型带勾连的目录结构和可装卸文件系统，了解Windows98 VFAT目录结构。熟悉目录查询技术，掌握内存的目录管理表，掌握文件操作与目录管理关系。

掌握基于索引节点的共享方式和利用符号连接的文件共享。

熟练掌握外存空间的管理方法

掌握文件的存取控制，熟悉分级安全管理，了解文件的转储和恢复，了解WindowsNT安全性。

## 8.1 文件系统概述

### 8.1.1 文件和文件系统

**文件**：文件时存储在某种介质上的（如磁盘、磁带等）并具有符号名字的一组有序信息的集合。

 

**数据项**（field）：描述一个对象的某些属性的字符集，是数据的基本单位，一个数据项有一个值

**记录**（record）：一组相关数据项的集合，用于描述一个对象某方面的属性

**文件**（file）：具有文件名的一组相关记录的集合

**数据库**（datebase）：相关数据的集合

 

**文件系统**：操作系统中以文件方式管理计算机软件资源的软件和被管理的文件和数据结构（如目录和索引表等）的集合

 

### 8.1.2 文件系统的类型

FAT文件系统

扩展文件表系统（vfat）

NTFS（NT文件系统）

S51K/S52K（sysv）

ext2（二级扩展文件系统）

HPFS（高性能文件系统，hpfs）

CD-ROM文件系统（iso9660）

UDF通用磁盘格式文件系统

 

### 8.1.3 操作系统（Windows98/NT、Linux）对多种文件系统的支持

**WindowsNT多重文件系统**

WindowsNT支持FAT、NTFS、HPFS、CD-ROM文件系统等多种文件系统，Windows NT执行体内I/O系统分成I/O管理程序、文件系统驱动程序和盘驱动程序三层，不同的文件系统采用不同的文件系统驱动程序，系统用动态链接库对这些文件系统进行装入和卸出并适宜于将来的发展。

 

**Linux虚拟文件系统VFS**

VFS是物理系统与服务之间的一个接口层，屏蔽各类文件系统的差异，给用户和程序提供一个统一的接口。Linux支持ext、ext2、msdos、vfat、iso9660、hpfs等多种文件系统。

 

### 8.1.4 文件系统模型

对象：文件、目录、管理外存空间的数据结构

基本文件系统：直接调用驱动程序，传送原始数据，对数据内容和结构不关心

**I/O基本管理程序：**

选择文件所在设备

逻辑块到物理块的转换

空闲盘块的管理

I/O缓冲的指定

逻辑文件系统：处理文件和记录的相关操作，例如管理文件目录，文件存取权限管理

文件系统接口：命令接口和程序接口

 

### 8.1.5 文件操作

**最基本的操作：**

创建文件

删除文件

读文件

写文件

截断文件

设置读/写位置

打开与关闭

其他文件操作：创建目录、删除目录、改变当前目录、对文件属性的操作等

 

## 8.2 文件的逻辑结构

从用户观点出发观察到的文件组织结构称为文件的逻辑结构，逻辑结构的文件称逻辑文件。逻辑文件从结构上分成两种形式：

无结构的流式文件：对文件内信息不再划分单位，是依次的一串字符流构成的文件

有结构的记录式文件：用户把文件内的信息按逻辑上独立的含义划分信息单位，每个单位称为一个逻辑记录

记录文件有顺序、索引、索引顺序、直接、分区和堆文件几种

 

### 8.2.1 顺序文件

**逻辑记录的排序**：顺序文件的记录定长，记录中的数据项的类型长度与次序固定，还有一个可以唯一标识记录的数据项：键（key），有两种结构：串结构（记录一般按先来后到的次序排列）和顺序结构（按键值的约定次序组织排列）

 

**对顺序文件的读写操作：**

设置一个读/写指针。Rptr或Wptr，指向记录的首地址，则下一条记录的首地址是：

对于长度为L的定长记录：Rptr（或Wptr）= Rptr（或Wptr）+L

对于变长记录：Rptr（或Wptr）= Rptr（或Wptr）+Li

 

优点：适合一次对大量数据的存取，能存储在磁带上。对于磁盘上的定长记录顺序文件，可以实现直接存取

缺点：查找记录效率低，增删记录不方便

 

### 8.2.2 索引文件

索引文件对主文件中的记录按需要的数据项（一个或多个）建索引表。这时记录可为不定长的，它为每个记录设置一个表项。索引文件本身是顺序文件组织。

 

优点：检索快，增删方便

缺点：需要额外的索引

 

### 8.2.3 索引顺序文件

基于键的约定次序组织的，为之建立一张索引表，为每个不同键值的记录组的第一个记录设置一个表项，为该组的其他记录设置了溢出区域，在溢出区域内记录按顺序文件方式组织。它是顺序文件和索引文件的结合。索引顺序文件既适用于交互方式应用，也适用于批处理方式应用。

 

### 8.2.4 其他逻辑文件

直接文件/哈希文件（The Direct/Hashed File）：对记录在直接访问存储设备上的物理地址直接（随机）访问，常用于需高速访问文件而且每次访问一条记录的应用中。

分区文件：由两部分组成，一部分是顺序子文件区，另一部分是对这些子文件索引的索引区。分区文件常用于储函数库、软件包等

堆（The Pile）文件：最简单的记录文件，数据按先来后到的次序组织，每个记录所包含的数据项是自我标识的，数据项的长度可以明确指定或使用界定符区分。在堆文件中访问所需要的目录需穷尽搜索，不适合大多数应用

 

## 8.3 文件的目录和管理

### 8.3.1 目录管理的目标

实现“按名存取”

提高对目录（文件）的检索速度

实现文件共享

允许文件重名

 

文件目录由许多目录项（文件控制块）构成，记录文件的有关属性

 

### 8.3.2 文件控制块FCB

为每个文件设置的用于描述和控制文件的数据结构，至少包括文件名和存放文件的盘物理地址，一个文件控制块FCB就是一个文件目录项，其中包含的信息有以下三类

 

**基本信息类**

文件名：标识一个文件的符号名，在每个系统中文件必须具有唯一的名字

文件的物理地址：对于连续文件就是文件的起始块号和文件总块数，对于MS-DOS是文件的起始簇号和文件总字节数，对于UNIX S V是文件所在设备的设备号、13个地址项、文件长度和文件块数等

**存取控制信息类**

文件的存取权限

**使用信息类**

文件的建立日期、最后一次修改日期、最后一次访问的日期

当前使用的信息：打开文件的进程数、在文件上的等待队列等

 

### 8.3.3 目录结构——多级目录

**单级目录结构**

在整个文件系统中只建立一张目录表，每个文件占一个表目

结构简单，能实现目录管理的基本功能——按名存取，查找速度慢，不允许重名，不便于实现文件共享

只适用于单用户环境

 

**多级目录结构**

允许用户在自己的目录中使用与其他用户文件相同的文件名，由于各用户使用不同的目录，其文件全名仍不相同

查找一个文件最多只需要查遍文件路径上各目录的子目录和文件，提高了检索目录的速度

为每个用户（或每个进程）设置一个“当前目录”，又称“工作目录”。进程对各文件的访问都相对于工作目录而设置路径，称其为相对路径，可缩短搜索路径，提高搜索速度

 

### 8.3.4 目录管理

**目录查询技术**

利用用户提供的文件名，对文件目录进行查询，找出该文件的文件控制块FCB，根据找到的FCB中所记录的文件物理地址，根据文件物理组织方式找出文件的盘块号，进而换算出文件在磁盘上的物理位置，最后启动磁盘驱动程序，将所需文件读入内存

 

对目录查询的技术有两种，线性检索法和Hash法

 

内存的目录管理表：把当前使用的文件目录表复制到内存，这样只要第一次使用某个目录表目时需要盘I/O来完成读入内存，以后使用该目录表目只要在内存中进行，不需再进行盘块I/O，提高了处理速度。由于只把正在使用的目录复制到内存而不是全部目录读入内存，所以内存目录所占容量也不大。

 

**文件操作与目录管理关系**

为了让用户灵活方便和有效地使用文件，文件系统提供许多有关文件的系统调用，即文件操作，供用户使用

**建立文件：**当用户提出在某个路径或目录下建立文件时，系统首先检查在该目录下有无相同名的文件，如果没有的话在磁盘目录中登记此文件，对UNIX系统则需给它分配索引节点，以保存文件存放的盘块号，同时在该目录文件中增加一个表目，记录文件名和相应的索引节点号

**打开文件**：在磁盘目录中找到该文件的FCB，对UNIX系统是找到它所在的目录文件的表目和磁盘索引节点，然后将此文件的目录文件表目和磁盘索引节点拷贝到内存，建立系统打开文件表和活动索引节点表有关表目，同时在PCB的用户打开文件表中增加表目，并建立PCB的fp指针指向系统打开文件表f_inode前，f_inode再指向内存索引节点表i-count前的关系

**读/写文件：**用户或进程读写文件时，利用PCB中用户打开文件表的fp指针从三表关系中找到所需读/写的文件所在的盘块，在系统打开文件表的表目中设置读写指针f_offset[2]分别记录了进程读/写文件的位置。如在写文件时增加或减少文件所用的磁盘块数，则要修改活动索引节点表的表目中的13个地址项i_addr[13]。

**关闭文件**：当文件操作完成后或暂时不用，均需及时使用“关闭”命令关闭文件，将已修改的文件目录信息及时写回到磁盘中，并释放文件供其他进程使用。

**删除文件：**如文件不需要则要用“删除”命令删除文件，根据用户提出的在某目录下的文件名，命令将该文件在目录文件中的表项和相应的索引节点内容删除，释放供它用

 

## 8.4 文件共享

### 8.4.1 基于索引节点的共享方式

在两个不同子目录下取了不同的文件名ls和dir，但他们具有相同的索引节点。

### 8.4.2 利用符号链接

采用两个文件目录表目指向同一个索引节点的连接称为文件硬连接，不利于文件删除其拥有的文件。系统为共享的用户创建一个link类型的新文件，将新文件登录在该用户共享目录项中。可以跨越文件系统，甚至可以通过计算机网络连接到世界上任何地方的机器中的文件。

缺点：其他用户读取符号连接的共享文件比读取硬连接的共享文件需要增多读盘操作

 

## 8.5 文件存储空间分配

### 8.5.1 新创建文件的存储空间（文件长度）分配方法

预分配：创建时一次分配指定的存储空间（如文件复制时的目标文件）

动态分配：需要存储空间时才分配（创建时无法确定文件长度），如写入数据到文件

 

### 8.5.2 文件存储单位：簇（cluster）

文件的存储空间通常由多个分立的簇组成，而每个簇包含若干个连续的扇区（sector）

**簇的大小：**

两个极端：大到能容纳整个文件，小到一个外存存储块

簇较大：提高I/O访问性能，减少管理开销，簇内碎片浪费问题严重

簇较小：碎片浪费较小，但存在簇编号空间不够的问题

**簇的分配方法**：

簇大小可变，其上限较大：I/O访问性能较好，文件存储空间的管理困难

簇大小固定，较小：文件存储空间使用灵活，但I/O访问性能下降，文件管理所需空间开销较大

 

**文件卷容量和簇大小的关系：**

文件卷容量越大，若簇的总数保持不变即簇编号所需位数保持不变，则簇越大，簇内碎片浪费越多

文件卷容量越大，若簇大小不变，则簇总数越多，相应簇编号所需位数越多

 

### 8.5.3 文件存储分配数据结构

连续分配：只需记录第一个簇的位置，适用于预分配方法

链式分配：在每个簇中有指向下一个簇的指针，通过合并将一个文件的各个簇连续存放，以提高I/O访问性能

索引分配：文件的第一个簇中记录了该文件的其他簇的位置。可以每次存放一个簇或连续多个簇

 

## 8.6 外存空闲空间管理

外存空闲空间管理的数据结构通常称为磁盘分配表（disk allocation table），分配的基本单位是簇。

### 8.6.1 空闲表法/空白文件目录法

把一个未分配区域看成一个文件，称为“空白文件”，为空白文件建立一张目录，记录空白文件的起始盘块号和空闲块数。

分配和回收：采用内存的动态分区管理方法，可以采用首次适应算法和循环首次适应算法分配，分配时也是将空白文件一分为二，一部分正好等于所需的大小，剩下部分构成新的空白文件，回收时考虑相邻空白文件要合并

特点：适合连续分配，索引分配和链式分配

 

### 8.6.2 空闲链表法

将文件存储空间中的所有空闲块用指针链接在一起形成链表，在某个固定地方存放链表的头指针

**空闲块链：**

以空闲盘块为基本单位形成链表，每个空闲盘块有一个指向下一个空闲盘块的指针

分配和回收：分配时从表头开始分配，回收后的盘块加入链表尾

特点：适合链式分配，索引分配

**空闲盘区链：**

以连续若干个空闲盘块组成一个空闲盘区，以空闲盘区为基本单位形成链表。每个空闲盘区应有表明本盘区大小的数据项和指向下一个空闲盘区的指针

分配与回收：可以采用首次适应算法，分配时从表头开始分配，分配时可以分配多个空闲盘区，最后一个一分为二，回收时可以合并相邻空闲盘区。

特点：适合连续分配、链式分配、索引分配

 

### 8.6.3 位示图法

用一个二进制位来标识一盘块的使用情况，磁盘上每个盘块都有一个二进制位对应，二进制位的序号就是对应盘块的编号，所有二进制位构成的集合就是位示图

特点：适合连续分配、链式分配、索引分配，占用空间少

 

### 8.6.4 成组链接法

结合空白文件目录法和空闲链表法

分配：从栈顶开始分配，每分配一个，N减一，若N=0，说明没有可以供分配的空闲盘块，若不是0，则需要把该盘块的内容读入空闲盘块号栈中，然后才能将它分配出去

回收：回收一个盘块X，若空闲盘块号栈的N=M，则把空闲盘块号栈中的内容写到盘块X中，把X的编号作为栈底写到空闲盘块号栈中，N=1；若N＜M，就把X写到空闲盘块号栈的底部，N加一

 

## 8.7 文件的保护和安全 

### 8.7.1 文件的存取控制

存取控制矩阵：一维列出计算机全部用户，另一维列出系统中的全部文件，矩阵中的每个元素表示用户对文件的权限（可读、可写、可执行及其组合）

存取控制表：按用户对文件的访问权力的差别对用户进行分类

用户权限表：以用户或用户组为单位将用户可存取的文件各集中起来存入一表

 

### 8.7.2 分级安全管理

**系统级安全管理**

注册：使系统管理员能够掌握要使用的各用户的情况，并保证用户在系统中的唯一性

登录：核实该用户的注册名及口令来检查用户使用系统的合法性

 

**用户级安全管理**：通过对不同的用户对不同文件设置不同的存取权限来实现

 

**目录级安全管理：**为了保护系统中的各种目录而设计的，与用户权限无关，规定只有系统核心才具有写目录的权利

 

**文件级安全管理：**通过系统管理员或文件主队文件属性的设置来控制用户会文件的访问

只执行：只允许用户执行该文件

```
隐含：隐含属性文件
索引：索引文件
修改：该文件自上次备份之后是否还被修改
只读：允许用户对文件进行读和写
共享：可读共享的文件
系统：系统文件
```

 

### 8.7.3 磁盘容错技术

文件数据的可靠性受三种因素的影响：认为、系统故障、自然因素

**防止：**

```
人为：采用权限控制机制

系统故障：磁盘容错技术

自然因素：备份、异地技术
```

 

磁盘容错技术又称系统容错技术SFT，分为三个级别：SFT-Ⅰ、SFT-Ⅱ、SFT-Ⅲ

```
SFT-Ⅰ：低级容错技术，主要防止因磁盘表面缺陷引起的数据丢失，主要技术有：双份目录和双份文件分配法、热修复重定向和写后读校验

SFT-Ⅱ：中级容错技术，主要防止因磁盘驱动器和磁盘控制器的故障引起的系统不能正常工作，主要技术有：磁盘镜像和磁盘双工

SFT-Ⅲ：高级容错技术
```

 

## 8.8 数据一致性控制

数据一致性：在某些数据处理时，保证数据都经过处理，不能出现有些处理了有些没有处理，使数据之间状态不一致

硬件解决：提供稳定存储器，例如：磁盘双工

 

### 8.8.1 事务

一段不能分割的程序执行，执行的结果应该使完整的，要么全部执行产生正常的结果，要么一点都不执行

 

**事务原语：**

```
Begin_Transaction    
End_Transaction
Abort_Transactiion
Read
Write
```

 

**事务特性：**

原子性：不可分割

一致性：事务执行后对数据之间的状态应该保持一致

独立性/隔离性/串行性：即使事务并发执行或并行执行，其结果是和某一顺序执行的结果相同

持久性：一个事务完成后所产生的影响是持久的

 

**事务的嵌套：**一个事务可以包含若干子事务，而子事务又可由它的许多子事务来完成

 

**事务日志：**设置一个日志文件，存放在稳定存储器中，日志中记录：事务名、被修改数据项名、旧值、新值

每次修改前需要在日志中记录修改情况并写到稳定存储器

事务夭折时利用登记表的记录恢复到修改前的状态，称为回滚（rollback）

 

### 8.8.2 检查点

当系统发生故障后，为加快恢复速度，需要在某事务完成后，把被修改数据写入稳定存储器，并做标志

 

### 8.8.3 并发控制：

利用信号量、管程等实现并发控制，还有一种实现机制：锁

锁的种类：互斥锁和共享锁

```
互斥锁用于实现临界区的互斥，对于写操作，需要使用互斥锁
共享锁用于实现可同时的读操作
```



### 8.8.4 重复数据的一致性问题

重复文件的一致性

文件分配表的一致性

共享文件计数器的一致性

 
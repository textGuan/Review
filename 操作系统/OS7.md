> 计算机操作系统 
>
> 教材《计算机操作系统（第四版）》 汤小丹等
>
> PPT 四川大学 杜中军老师
>
> Find more on github.com/textGuan/Review

# 第七章 设备管理

了解设备的分类，熟悉设备管理的目标和功能。

熟悉程序I/O方式、中断方式、DMA方式和通道方式四种I/O的控制方式；掌握通道的概念，熟悉通道类型。

熟悉缓冲的概念，熟悉单缓冲、双缓冲和多缓冲和缓冲池工作原理，了解UNIX系统的缓冲技术。

了解在进行设备分配时应考虑的设备的固有属性、设备的分配算法、设备分配的安全性和设备的独立性等因素；掌握设备分配中数据结构，熟悉设备分配的流程；掌握SPOOLing技术概念和SPOOLing系统的组成。

熟悉设备处理程序的功能和处理方式，熟悉设备处理程序的处理过程。

熟悉掌握磁盘的组织格式，熟悉FCFS、SSTF、SCAN等驱动调度的算法，掌握CSCAN算法、N-Step-SCAN和FSCAN调度算法，了解提高磁盘I/O的方法和廉价磁盘冗余阵列。

## 7.1 设备管理的概述

### 7.1.1 I/O系统的组成

**微机I/O系统：**

CPU、内存、控制器、外设

**主机I/O系统：**

内存中有通道，通道中有控制器，控制器连接外设

### 7.1.2 设备分类

I/O设备的种类繁多，其重要的性能指标有：数据传输速率、数据的传输单位、设备的共享属性等

 

**按传输速率分类：**

低速设备：传输速率（下同）每秒钟几个字节到几百个字节的设备（键盘、鼠标、语音输入等）

中速设备：数千个到数十千个字节——行式打印机、激光打印机等

高速设备：数百千个到数兆字节——磁带机、磁盘机、光盘机等

 

**按信息交换的单位分类：**

块设备：以数据块为单位来组织和传送数据信息的设备。这类设备用于存储信息，属于有结构设备。传输速率较高，可寻址的，I/O采用DMA方式

字符设备：以单个字符为单位来传送数据信息的设备，用于数据的输入和输出，无结构设备，传输速率较低、不可寻址、I/O采用中断驱动方式

 

**按资源分配的角度分类：**

独占设备：一段时间内只允许一个用户/进程访问的设备，大多为低速的I/O设备，属于临界资源，并发进程必须互斥地进行访问

共享设备：一段时间内允许多个进程同时访问的设备，必须是可寻址的和可随机访问的设备，良好的设备利用率和实现文件系统和数据库系统的物质基础

虚拟设备：通过虚拟技术将一台独占设备变换为若干台供多个用户/进程共享的逻辑设备，一般可利用假脱机技术（SPOOLing）实现

 

### 7.1.3 设备管理的目标和功能

**设备管理的目标：**

**提高设备的利用率**——主要利用中断技术、DMA技术、通道技术、缓冲技术

**为用户提供方便、统一的界面**

 

**设备管理功能**

**设备分配**——按照一定的算法将某个I/O设备及其相应的设备控制器和通道分配给某一用户/进程，对于未分配到的则插入到等待队列

**缓冲区管理**——解决CPU和I/O之间速度不匹配的矛盾，设备管理程序需要管理缓冲区的建立、分配和释放

**实现物理I/O设备的操作**：根据用户I/O要求生成相应的通道程序并提交给通道，用专门的通道指令启动通道，对指定的设备进行I/O操作，并能相应通道的中断请求。对于未设置通道的系统，设备管理程序直接驱动设备进行I/O操作

 

## 7.2 I/O控制方式

一般分为程序I/O方式、中断方式、DMA方式和通道方式，其发展目标是尽量减少主机对I/O控制的干预

 

### 7.2.1 程序I/O方式

在CPU中向设备控制器发送一条I/O指令启动I/O设备进行数据传输时，同时把状态寄存器中的忙/闲标志busy置1，然后便不断地循环测试busy。当busy=1时，表示该I/O设备尚未输完一个字符，CPU应继续对该标志进行测试，直到busy=0，表示该I/O设备已将输入数据送入到I/O控制器的数据寄存器中，于是CPU从数据寄存器中取出数据送入内存的指定单元，再去读取下一个数据并置busy=1

 

CPU的极大浪费，但是其管理简单，要求不高的场合可以被采用

 

### 7.2.2 中断控制方式

当某进程要启动某个I/O设备时，便由CPU向相应的设备控制器发出一条I/O命令，然后立即返回继续执行原来的任务。设备控制器便按照该命令的要求去控制I/O设备。此时， CPU与I/O设备处于并行工作状态。

当设备控制器收到了CPU发来的读命令后，便准备接收从相应输入设备送来的数据。一旦数据进入数据寄存器，控制器便通过控制线向CPU发送一中断信号，由CPU检查输入过程中是否出错，若无错，便向控制器发取走数据的信号，然后通过控制器将数据写入指定内存单元

 

提高了整个系统的资源利用率和吞吐量，特别是CPU的利用率

 

### 7.2.3 DMA控制方式

直接存储器访问控制，其特点是：数据传输的基本单位是数据块，I/O操作的类型比较简单

需要一个专门的DMA控制器，其中有控制、状态寄存器、传送字节计数器、内存地址寄存器和数据缓冲寄存器

采用盗窃总线控制权的方法，不用CPU的干预，传输效率高

仅在传送一个或多个数据块的开始和结束时才需要CPU的干预，整块数据的传送是在控制器的控制下完成的

 

减少了CPU对I/O控制的干预，进一步提高了CPU与I/O设备的并行操作程度

 

### 7.2.4 I/O通道控制方式

大中型计算机系统中，普遍采用由专用的I/O处理机来接受CPU的委托，独立执行自己的通道程序来实现I/O设备与内存之间的信息交换，即通道技术。

进一步减少CPU的干预

通道时通过执行通道程序，并与设备控制器来共同实现对I/O设备的控制。通道程序由一系列的机器指令（通道命令）所构成，与一般的机器指令不同，通道指令中包含操作码、内存地址、计数、通道程序结束位P和记录结束标志R

通道类型根据信息交换方式分为三种类型：

**字节多路通道：**含有较多个非分配型子通道，每个子通道连接一台I/O设备，这些子通道按时间片轮转方式共享主通道。一个子通道完成一个字节的传送后立即让出字节多路通道（主通道）给另一个子通道使用——适用于低速或中速设备

**数组选择通道**：可连接多台I/O设备但是只有一个分配型子通道，在一段时间内只能执行一道通道程序、控制一台设备进行数据传送（一旦占用便独占直到传送完毕释放通道）——适用于高速设备，通道利用率低

**数组多路通道：**每次只允许一个设备传输数据，将字节多路通道和数组选择通道的优点结合起来形成的新的通道——很高的数据传输速率和令人满意的通道利用率

 

## 7.3 缓冲技术

为了解决CPU与I/O设备间速度不匹配的问题，使用缓冲区来交换数据

### 7.3.1 缓冲的引入

改善CPU与I/O设备间速度不匹配的矛盾

减少对CPU的中断频率，放宽对中断响应时间的限制

提高CPU和I/O设备之间的并行性

### 7.3.2 单缓冲

每当一个用户进程发出一个I/O请求时，OS便在主存中为之分配一个缓冲区，缓冲区中数据的输入和提取是串行工作的

### 7.3.3 双缓冲

在设备输入时，先将数据输入到缓冲区A，装满后便转向缓冲区B，此时OS可从缓冲区A中提取数据传送到用户区

### 7.3.4 多缓冲

增加双缓冲中缓冲区的个数

 

**进程同步：**

​       无空缓冲：E+1=F，输入进程阻塞，计算进程消耗一个缓冲后唤醒它

​       无数据：E=F，计算进程阻塞，输入进程在装满一个缓冲后唤醒它

 

### 7.3.5 缓冲池

对于同时用于输入/输出的公用缓冲池，至少含有三种类型的缓冲区：空缓冲区、装满输入数据的缓冲区和装满输出数据的缓冲区，将相同类型的缓冲区链成一个队列

 

**缓冲控制块**：设备号、盘块号、状态、指向缓冲区的指针、指向散列队列的后继buf的指针、指向散列队列的前驱buf的指针、指向自由链的后继buf的指针、指向自由链的前驱buf的指针

缓冲池结构：利用缓冲控制块的两组指针，将缓冲池中的缓冲区用两条双向链表环组织起来，自由链中全为“空闲”状态的buf，散列队列中可以有多个队列，各个队列是具有相同散列值的buf，散列值是设备和盘块号的函数

 

**缓冲区的分配和释放**

当进程想从指定的盘块读取数据或把数据写到指定的盘块中时，核心要检查该块是否在缓冲区中，如果不在，则为该盘块分配一个空闲的缓冲区。当核心用完缓冲区后，要将其释放，链入自由链中。

核心对缓冲区的分配是采用LRU算法

 

## 7.4 设备的分配

多道程序环境下设备必须由系统分配，在分配设备时将所需的设备及其有关资源（如缓冲区、控制器和通道）分配给该进程。在分配设备时还必须考虑到系统的安全性，避免出现死锁现象

### 7.4.1 设备分配的策略

根据设备的固有属性而采取的策略

**独享方式：**将一个设备分配给某进程后便一直由它独占，直至该进程完成或释放该设备为止——设备利用率低，会引起设备死锁

**共享方式**：将共享设备同时分配给多个进程使用，进程对设备的访问需进行合理的调度

**虚拟方式**：通过高速的共享设备，将一台慢速的以独占方式工作的物理设备改造成若干台虚拟的同类逻辑设备，需要引进SPOOLing技术。虚拟设备属于逻辑设备

 

**设备分配算法（与进程的调度算法相似）**

**先来先服务**

**优先级高者优先**

 

**设备分配中的安全性**

**安全分配方式：**每当进程发出一个I/O请求后便进入阻塞状态，直到其I/O操作完成时才被唤醒，当它运行时不保持任何设备资源。这种分配算法使得CPU与I/O设备串行工作，设备利用率低

**不安全分配方式：**进程发出一个I/O请求后仍可以继续运行，需要时还可以发起第二个、第三个I/O请求，只有当进程所请求的设备已被另一个进程占用时，进程才进入阻塞状态。

 

在设备分配程序中应增加安全性检查的功能

 

**设备独立性**

用户程序不直接使用物理设备名，而是只能使用逻辑设备名，而系统在实际执行时，将逻辑设备名转换为某个具体的物理设备名

**设备分配时的灵活性：**如一台设备已经分配给其他进程或正在检修，系统可以将其他几台相同的空闲设备中的任一台分配给该进程，直到此类设备全部被分配完，进程阻塞

**易于实现I/O重定向：**设置逻辑设备表LUT，将应用程序张所使用的逻辑设备名映射为物理设备名，并提供该设备驱动程序的入口地址

 

### 7.4.2 设备分配程序

**设备分配中数据结构**

**系统设备表（SDT）：**记录系统中全部设备的信息，每个设备占一个表目，其中包括设备类型、设备标识符、设备控制表指针及设备驱动程序的入口地址等表项

**设备控制表（DCT）：**

设备队列的队首指针：指向队首PCB，有的系统中还设置了队尾指针

设备状态：设备处于“忙”状态时，设备忙标志置“1”，若其连接的控制器或通道处于“忙的状态，则将设备等待标志置“1”

COCT（控制器控制表）指针：指向与该设备相连接的控制器的控制表

重复执行次数：若发送信息传送错误，只要在规定的重复次数或时间内恢复正常传送，则仍认为传送成功

 

**设备分配的流程**

进程P提出所需I/O设备，根据物理设备名从SDT中找出该设备的DCT，检查其是否正忙，若忙或不忙但不安全，则将该进程的PCB插入到该设备的等待队列中，若不忙且安全则将该设备分配给进程，从设备DCT中找出与该设备连接的控制器的COCT，检查是否忙，若忙则进程PCB插入控制器等待队列，不忙则将控制器分配给进程，再从COCT中检查与控制器连接的通道的CHCT，不忙则分配该通道给进程。设备、控制器、通道均分配成功，启动I/O设备，进行具体I/O操作

 

**设备分配程序的改进**

采用多通路的I/O系统结构，此时对多个控制器和通道的分配，必须查找所有的控制器和通道，才能决定是否将该进程挂起

 

### 7.4.3 SPOOLing技术

把低速I/O设备上的数据传送到高速的磁盘上，再用另一道程序来模拟脱机输出时外围控制机的功能，把数据从磁盘传送到低速I/O设备上，在主机的直接控制下，实现脱机输入、输出功能。

 

**SPOOLing系统的组成：**

**输入井和输出井**：磁盘上，输入井模拟脱机输入时的磁盘，用于收容I/O设备输入的数据，输出井模拟脱机输出时的磁盘，用于收容用户程序的输出数据

**输入缓冲区和输出缓冲区：**内存中，输入缓冲区用于暂存从输入设备送来的数据，再传送到输入井，输出缓冲区用于暂存从输出井送来的数据，再传送给输出设备

**输入进程和输出进程：**输入进程模拟脱机输入时的外围控制机，将用户要求的数据从输入机通过输入缓冲区再送到输入井，当CPU需要输入数据时，直接从输入井读入内存，输出进程模拟脱机输出时的外围控制机，把用户要求输出的数据先从内存送到输出井，待输出设备空闲时，再将输出井中的数据，经过输出缓冲区送到输出设备上。

 

## 7.5 设备处理

### 7.5.1 设备处理程序的功能和处理方式

**设备驱动程序的功能**

接收上层软件发来的抽象要求，再将其转换成具体要求

检查用户I/O请求的合法性，了解I/O设备的状态，设置工作方式

对于设置有通道的计算机系统，驱动程序还应能够根据用户的I/O请求自动构成通道程序

由驱动程序向设备控制器发出I/O命令，启动分配到的I/O设备，完成指定的I/O操作

及时响应由控制器或通道发来的中断请求，并根据其中断调用响应的中断处理程序进行处理

 

**设备处理方式**

为每一类设备设置一个I/O进程

整个系统中设置一个I/O进程（又可分为输入进程和输出进程）

不设置专门的设备处理进程，而是只为各类设备设置相应的设备处理程序，供用户进程和系统进程调用

 

**设备驱动程序的特点**

与硬件紧密联系，是I/O请求进程与设备控制器之间的通信接口

不同类型的设备都需要相应的驱动程序，因为控制命令和端口等可能不一样

与硬件紧密相关的程序一般都用汇编编写，有的标准设备的驱动程序已经固化在ROM中

 

### 7.5.2 设备处理程序的处理过程

**设备驱动程序的处理过程**

将用户和上层软件对设备控制的抽象要求转换成对设备的具体要求

检查I/O请求的合理性

读出和检查设备的状态，确保设备处于就绪态

传送必要的参数，如传送的字节数，数据在主存的首址等

工作方式的设置

启动I/O设备，并检查启动是否成功

 

**中断处理程序的处理过程**

当中断处理程序开始执行时，都必须去唤醒阻塞的驱动（程序）进程

保护被中断进程的CPU现场

分析中断原因，转入相应的设备中断处理程序

进程中断处理，判别此次I/O完成是正常结束中断还是异常结束中断，分别作相应处理

恢复被中断进程或由调度程序选中的进程的CPU的现场

返回被中断的进程，或进入新选中的进程继续运行

 

## 7.6 磁盘I/O

提高磁盘I/O的途径：

```
性能好的磁盘：旋转速度快，存取速度快等
采用好的磁盘调度算法
设置磁盘高速缓冲区
```



### 7.6.1 磁盘性能简述：

磁盘的组织：一个磁盘可包含多个盘片，每片分上下两个盘面，每面分若干磁道，每道由若干扇区构成

磁盘类型：

```
固定磁头磁盘：每条磁道上都有一个读写磁头，可同时访问所有磁道，提高I/O速度
移动磁头磁盘：每个扇面仅有一个磁头，读写时，需移动磁头到所要访问的磁道上才能读写该磁道
```

 

磁盘访问时间：

```
寻道时间Ts：磁头从当前位置移到要读写磁道上所需要的时间
旋转延迟时间Tr：要读写的扇区旋转到磁头下所经过的时间

传输时间Tt：把数据读出或写入磁盘所经过的时间。若读写的字节数是b，磁道上的总字节数N，磁盘旋转时间是r转/秒，则：b/传输时间Ts=N/1/r=rN
即，Ts=b/rN
```

```
访问时间Ta=Ts+Tr+b/rN
平均Tr=（0+1/r）/2 =1/2r
```

 

### 7.6.2 磁盘调度算法

**先来先服务**

**最短寻道时间优先法**

**扫描法（SCAN）/电梯算法**：磁头从一端向另一端移动，若在移动方向上发现有I/O请求，则响应；若移动方向上无I/O请求，则返回，向另一端移动

**循环扫描法（CSCAN）：**磁头从一端向另一端移动，若在移动方向上发现有I/O请求，则响应；若在移动方向上无I/O请求，则返回另一端上有请求的最小磁道上

**N-Step-SCAN算法**：将I/O请求分成若干长度为N的子队列，先按FCFS依次处理这些子队列，而在子队列内部按SCAN算法处理

**FSCAN算法**：N-Step-SCAN算法的简化，分2个子队列，一个是当前所有I/O请求队列，另一个是在扫描期间出现的I/O请求队列

 

### 7.6.3 磁盘高速缓存

磁盘高速缓存的形式

专门设置，在内存中划出一块大小固定空间作为磁盘高速缓存

与请求分页系统一样地使用内存空闲块作为高速缓存，需要时才临时进行分配，因此大小不固定，与系统进程竞争

 

数据交付方式：指将磁盘高速缓存中的数据传送给请求进程

**数据交付**：把高速缓存中的数据拷贝到请求进程的内存工作区

**指针交付**：把指向高速缓存中某区域的指针传递给请求进程

 

**置换算法：**与请求调页一样，存在需要读入数据，而高速缓存已满的情况，因此需要置换算法，考虑：

访问频率

可预见性：有些数据在很长时间内不会再使用，有的含快就会使用

数据一致性

 

周期性回写磁盘：每隔一定时间把高速缓存中已修改数据写回磁盘，降低系统故障造成数据丢失的程度

 

### 7.6.4 提高磁盘I/O的其他方法

**提前读**

**延迟写**：本应写入磁盘的缓冲区，释放缓冲区，考虑接下来可能还要被使用，不立即写磁盘，暂时放在空闲缓冲区的尾部，在没有其他空闲缓冲区时，才写回磁盘并分配它

**优化物理块的分布：**使磁头移动距离最小

 

### 7.6.5 廉价磁盘冗余阵列

利用磁盘阵列控制器来统一管理和控制一组磁盘驱动器，组成一个高度可靠、快速的大容量磁盘系统

并行交叉存取：将磁盘盘块依次在各个磁盘顺序编号

RAID分级：分7个级别

```
RAID 0：仅提供并行交叉存取。
RAID 1：具有镜像功能，数据同时并行写入主盘和镜像盘
RAID 2：写入数据时在一组磁盘上保存数据的各个位，同时把一个数据不同的位运算得到的海明校验码保存在另一组磁盘上
RAID 3：带奇偶校验码的并行传送
RAID 4：带奇偶校验码的独立磁盘结构
RAID 5：具有独立传送功能的磁盘阵列，每个磁盘独立进行读写
```

 

RAID的优点：可靠性高、I/O速度快、性价比高
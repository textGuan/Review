> 计算机操作系统 
>
> 教材《计算机操作系统（第四版）》 汤小丹等
>
> PPT 四川大学 杜中军老师
>
> Find more on github.com/textGuan/Review

# 六 虚拟存储器

掌握虚拟存储器的理论基础和定义，熟悉虚拟存储器实现方式和特征。

掌握请求分页的页表机制、缺页中断机构和地址变换机构，熟悉页面的分配和置换策略、页面的分配的算法。

熟练掌握最佳置换算法、先进先出（FIFO）置换算法、最近最久未使用置换算法LRU，掌握Clock置换算法和页面缓冲算法；掌握有效访问时间计算，熟悉工作集概念。

掌握请求分段的段表机制、缺段中断机构和地址变换机构，熟悉分段的共享和保护。

 

## 6.1 虚拟存储器的基本概念

### 6.1.1 虚拟存储器的引入

**内存容量与需求的矛盾**

```
内存空闲容量有限，大作业无法一次性装入
有大量作业需要运行，但只能运行部分作业，其他在外存等待
```

**原因分析**

```
一次性装入
作业驻留内存
```

**解决方法**：引入虚拟存储器

 

**局限性表现为：**

**时间局限性：**如果程序中的某条指令一旦执行，则不久的将来该指令可能再次被执行；如果某个存储单元被访问，则不久以后该存储单元可能再次被访问。

**空间局限性：**一旦程序访问了某个存储单元，则在不久的将来，其附近的存储单元也有可能被访问。



根据局部性定理，一个作业在运行之前，没有必要把全部作业装入内存，而仅将那些当前要运行的那部分页面或段，先装入内存便可启动运行，其他部分暂时留在磁盘上。

程序在运行时如其所要访问的页／段已调入内存，则可继续执行下去，若未调入，则需利用OS提供的请求调页／段功能将其调入内存。如若此时内存已满，则利用置换功能将暂时不同的页／段调出至磁盘上，再将所需的页／段调入内存。这样，使一个大的用户程序在较小的内存空间中运行，这样的存储器称为虚拟存储器。

虚拟存储器是具有请求调入功能和置换功能，能仅把作业的一部分装入内存便可运行作业的存储器系统，从逻辑上对内存容量进行扩充到一种虚拟的存储器系统。

 

### 6.1.2 虚拟存储器实现方式

**请求分页系统**

在分页系统的基础上，增加了请求调页功能和页面置换功能所形成的页式虚拟存储系统。允许只装入若干页的用户程序和数据，就可以启动运行，以后再通过调页功能和页面置换功能将要运行的页面调入内存，将暂不运行的页面置换到外存上。置换时以页面为单位。

**请求分段系统：**

与请求分页系统类似，置换时以段为单位

请求段页式系统：在段页式系统的基础上增加了请求调页和页面置换功能所形成的段页式虚拟存储系统。

### 6.1.3 虚拟存储器的特征

**多次性：**一个作业被分成多次调入内存运行－最重要的特征

**对换性：**允许在作业的运行过程中在内存和外存的对换区之间换进换出

**虚拟性：**能够从逻辑上扩充内存容量，使用户看到的内存容量远大于实际内存容量

 

## 6.2 请求分页存储管理方式

### 6.2.1 请求分页中的硬件支持

**页表机制：**

状态位（存在位P）：用于指示该页是否已调入内存

访问字段A：记录本页在一段时间内被访问的次数，或最近已有多长时间未被访问

修改位M：该页在调入内存后是否被修改过

外存地址：指出该页在外存上的地址，供调入该页时使用，通常是物理块号

 

**缺页中断机构**

当要访问的页面不在内存时，产生一缺页中断，请求OS将所缺页调入内存。

缺页中断在指令执行期间产生和处理中断信号

缺页中断返回到该指令的开始重新执行该指令

一条指令在执行期间可能产生多次缺页中断

 

**地址变换机构**

在分页系统的地址变换机构的基础上，为实现虚拟存储器而增加了某些功能所形成的，如产生和处理中断，以及从内存中换出一页的功能等等

 

### 6.2.2 页面分配

**最少物理块数**

能保证进程能正常运行所需的最少物理块数，若系统为某进程所分配的物理块数少于此值，进程将无法运行

 

**页面的分配和置换策略**

**固定分配局部置换策略：**为每个进程分配一固定页数的内存空间，在整个运行期间都不再改变。若进程在运行中发现缺页，则只能调入调出，保证分配给该进程的内存空间不变

**可变分配全局置换策略：**系统为每个进程分配一定数目的物理块，OS自身也保持一个空闲物理块队列。当某进程发现缺页时，系统从空闲物理块队列中取出一物理块分配给该进程。空闲物理块队列用完之后OS才从内存中选择一页调出。

**可变分配局部置换：**根据进程类型或程序员的要求，为每个进程分配一定数目的内存空间；但当某进程出现缺页时，只允许从该进程在内存的页面中选取一页换出，而不影响其他进程的运行

 

**页面分配算法：**

**平均分配算法：**将系统中所有可供分配的物理块，分配给各个进程

**按比例分配算法：**根据进程的大小按比例分配物理块

**考虑优先权的分配算法：**把内存中可供分配的所有物理块分成两部分，一部分按比例分配给各进程，另一部分根据各进程的优先权适当地增加其相应份额后分配给各进程

 

### 6.2.3 页面调入策略

**调入页面的时机：**

预调页策略：主动的缺页调入策略，将那些预计在不久的将来会被访问的程序或数据所在的页面预先调入内存。

请求调页策略：当进程在运行中发生缺页时，就立即提出请求，由系统将缺页调入内存。缺点是须花费较大的系统开销。

 

**调入页面的来源：**

对换区足够大，则全部从对换区调入

对换区不足够大，未修改页面从文件区调入，修改的页面从对换区调入

在UNIX系统中，对于从未运行过的页面，都应从硬盘文件区调入，对于曾经运行过而又被换出的页面，可以从对换区调入，对于共享页面，该页面可能已可由其他进程调入内存，此时就无需再从对换区调入。

 

### 6.2.4 页面置换算法

不适当的算法可能会导致进程发生抖动，即页面频繁调进调出，以致一个进程在运行中把大部分时间花费在完成页面置换的工作上，我们称该进程发生了“抖动”

 

**最佳置换算法：**

选择那些永不使用的，或者最长时间内不再被访问的页面置换出去

**先进先出置换算法：**

总是淘汰最先进入内存的页面

**最近最久未使用置换算法：**

选择最近一段时间内最久未使用的页面予以淘汰，系统在每个页面设置一个访问字段用于记录这个页面自上次被访问以来所经历的时间T

**最近未用算法：**

为每个页面设置一个访问位，将内存中的所有页面都通过链接指针链成一个循环队列。将某页被访问时，其访问位置“1”，在选择一页淘汰时，检查其访问位，若为“0”则换出，若为“1”则设置为“0”但是暂不换出

**最少使用置换算法：**

选择最近时期使用最少的页面作为淘汰页，需要为内存中某个页面设置一个移位寄存器来记录页面被访问的频率，每次访问某页时，将该页面对应的一位寄存器最高位置1，每隔一定时间右移一位‘移位寄存器值最小的就是使用最少的页面。

**页面缓冲算法：**

 

**性能分析：**

```
有效访问时间＝（1－缺页率）＊访问时间＋缺页率＊缺页中断时间
```

 

**工作集：**在某段时间间隔里，进程实际需要访问的页面的集合

 

## 6.3 请求分段存储管理方式

### 6.3.1 硬件支持

除了段名（号）、段长、段在内存的起始地址外，还增加了以下几项：

存取方式：标记本分段的存取属性是只执行、只读还是运行读／写

访问字段A：用于记录该段被访问的频繁程度

修改位M：用于表示该段在进入内存后，是否已经被修改过

存在位P：说明本段是否已调入内存

增补位：表示本段在运行过程中，是否进行过动态增长

外存起址：指示本段在外存中的起始地址，即起始盘块号

 

**缺段中断机构：**

在请求分段系统中，当进程所要访问的段未调入内存时，便由缺段中断机构产生一缺段中断信号，由缺段中断处理程序将所需的段调入内存。

 

**地址变换机构：**

由于被访问的段并非全在内存，所以在地址变换时，若发现所要访问的段不在内存时，必须先将所缺的段调入内存，并修改了段表之后才能再利用段表进行地址变换

 

**段的动态链接：**

静态链接：经过编译或汇编得到的一组目标程序需经链接程序，连接装配成一个一维的线性连续地址空间。

在一个程序运行开始时，只将主程序装配好并调入主存，其他各段的装配是在主程序段运行过程中逐步进行的，每当需要调用一个新段时，再将该段装配好，并与主程序段连接

 

### 6.3.2 分段共享与保护

共享段表：

用来记录每一个共享段的段号和段长、内存始址、存在位等信息

共享进程计数器COUNT：记录有多少个进程需要共享该分段

存取控制字段：说明不同的进程对该分段不同的存取权限

段号：对于同一个共享段，不同的进程可以使用不同的段号去共享该段

 

### 6.3.3 共享段的分配与回收

分配：

首次请求：分配空闲分区，调入内存，初始化进程段表，在共享段表中增加一表项，初始化数据，count＝1，在共享段表中添加调用进程信息

非首次请求：count＋1，在共享段表中添加调用进程信息

回收：count＝count－1，取消调用进程信息，如count＝0，则在共享段表中取消该共享段表项，同时释放他所占内存。

分段保护：

越界检查

存取控制检查：段表中有“存取控制”字段规定访问权限（只读、只执行、读写）

环保护机构：低编号环具有高优先访问权

```
一个程序可以访问处于相同环或较低特权环中的数据
一个程序可以调用处于相同环或较高特权环中的服务
```


> 计算机操作系统 
>
> 教材《计算机操作系统（第四版）》 汤小丹等
>
> PPT 四川大学 杜中军老师
>
> Find more on github.com/textGuan/Review

# 第四章 调度和死锁

熟悉处理机三级调度概念和处理机调度模型，掌握作业的状态和作业调度的功能。掌握进程调度的方式和功能，熟悉调度方式和算法的选择准则，掌握七种调度算法及适合范围。掌握死锁的定义和产生死锁的原因，掌握死锁的四个必要条件；熟悉预防死锁的方法，熟练掌握银行家算法及其在死锁避免中的应用；掌握资源分配图的简化及其死锁定理，熟悉解除死锁的方法。

## 4.1 调度

### 4.1.1 处理机三级调度

**高级（long-term）调度——作业调度**

用于决定把外村输入井上处于作业后备队列上的哪些作业调入内存，并为他们创建进程，分配必要的资源，然后再将新创建的进程排在就绪队列上，准备执行。

```
分时系统中，通过键盘输入的命令和数据直接进入内存，无需作业调度。
```

**低级（short-time）调度——进程调度**

决定就绪队列中哪个进程将获得处理机，然后由分派程序执行把处理机分配给该进程的操作。任何操作系统都有进程调度。

**中级（medium-term）调度——对换**

为了提高主存利用率和系统吞吐量。将暂时不能运行的进程从内存调到外存盘交换区去等待，而将在盘交换区的等待事件已发生急需调度运行的进程从盘交换区调入内存。采用虚拟存储技术的分时系统往往设立中级调度。

### 4.1.2 作业调度

#### **作业的状态**

作业从运行到运行结束，一般需要经历“提交”、“后备”、“运行”和“完成”四个阶段

**提交状态：**作业被提交给机房后正在通过SPOOLing系统进行输入或用户通过终端向计算机中键入其作业时所处于的状态

**后备状态：**作业已经过SPOOLing系统输入到磁盘输入井，等待调入内存运行，此时作业处于后备状态。

为管理和调度作业，为每个作业设置一个作业控制块（JCB，记录作业类型、资源要求等有关信息，按作业类型组成一个或多个后备作业队列）

**运行状态：**一个在后备作业队列的作业被作业调度程序段中后，分配必要的资源，建立一组相应的进程后，调入内存，该作业进进入运行状态。

进程各状态（进程运行态、内存进程就绪态、内存阻塞态、外存进程就绪态、外存进程阻塞态等）都对应作业运行状态

**完成状态：**进程正常运行结束或因发生错误而终止时，作业进入完成状态。终止作业程序将负责善后处理



#### **作业状态的转换**

**作业调度**

作业调度程序按照一定的算法从后备作业行列中选一个满足资源要求的作业，分配它所要求的资源，建立一组相应的进程，设置该进程状态为就绪态，并将该进程插入内存就绪行列，参与CPU争夺

**终止作业**

当进程正常运行结束或因发生错误终止时，调用终止作业程序 ，将输出文件缓冲输出到输出井，并调用SPOOLing系统输出进程将作业输出文件在打印机输出。同时回收作业所使用内外存、I/O设备等各种资源，最后调用记账程序结清作业费用。

 

### 4.1.3 处理机调度模型

**仅有进程调度的调度队列模型**

在分时系统中通常仅设置了进程调度，此时系统有一个就绪队列，每个进程运行一个时间片，进程运行一个时间片后如未完成，则被放在就绪队列末尾。如进程运行中因等待某事件，则需排入阻塞队列，系统因阻塞原因不同可设置几个阻塞队列

**有进程调度和中级调度队列模型**

具有虚拟存储器技术的分时系统中一般采用，比第一种模型增加了中级调度，则相对于上模型也增加了外存进程就绪队列和外存进程阻塞队列。或从内存就绪队列调度到外存就绪队列，或从内存阻塞队列调到外存阻塞队列，或从外存进程就绪队列调到内存就绪队列。

**具有高级调度和低级调度的调度队列模型**

在多道批处理系统中，一般处理机管理设置作业和进程两级调度。比第一个模型增加了高级调度。模型增加了磁盘的作业后备队列，作业调度的任务是从作业后备队列中选一个作业为它创建至少一个进程，并分配资源，将它排入内存进程就绪队列末尾

**同时具有三级调度的调度队列模型**

通用系统的多模式OS中一般采用，由于多模式OS同时支持批处理、分时和实时处理，所以它必须具有以上模型。

### 4.1.4 进程调度

#### **进程调度的方式**

**非抢占方式**

```
进程完成或发生某事件而被阻塞时才把处理机分配给其他进程
实现简单，系统开销小，适用于大多数批处理系统环境
难以满足紧急任务的要求，不适用于实时、分时系统要求
```

**抢占方式**

```
时间片原则：各进程按时间片运行，当一个时间片用完后，停止该进程的执行而重新进行调度，适用于分时系统
优先权原则：优先权比正在执行的进程优先权高的进程进入就绪队列时，停止正在执行的进程，将处理机分配给优先权高的进程
短进程优先原则：当进入就绪状态的进程预计执行时间比现运行进程明显短，可以抢占处理机
```

 

**进程调度的功能**

记录系统中所有进程的执行情况

#### 选择占有处理机进程

进行进程上下文切换

 

### 4.1.5 调度方式和算法的选择准则

#### **面向用户的准则和评价：**

**周转时间短：**

```
作业周转时间：从作业提交到作业完成的时间间隔
作业带权周转时间：作业周转时间/实际服务时间
```

**响应时间快**

```
 用户提交请求开始到系统首次产生相应为止的时间
```

**截止时间的保证**

```
某任务必须执行/必须完成的最迟时间
```

**优先权准则**

 

#### **面向系统的准则**

**达到系统设计目标**——选择算法的主要依据

**系统吞吐量大**——评价批处理系统的重要指标

**处理机利用率高**

**各类资源的平衡利用**

 

### 4.1.6 作业/进程调度算法

**先来先服务算法（FCFS）：**按照作业到达先后次序，非抢占方式

**短作业/进程优先（SJF）：**有利于短作业，不利于长作业，有利于减少系统平均周转时间和平均带权周转时间，提高系统吞吐量

**时间片轮转法**：保证就绪队列中的所有进程在给定的时间内均可以获得一时间片处理机执行时间

**高响应比优先调度算法**：每次选择作业投入运行时先计算后备作业队列中每个作业的响应比然后选择值最大的作业投入运行。响应比=（已等待时间+要求运行时间）/要求运行时间

**优先权调度算法：**按照进程的优先权大小来调度，使高优先权进程得到优先处理

**多级队列调度算法**：根据作业的性质和类型的不同，将就绪队列再分为若干个子队列，所有的作业（或进程）按其性质排入相应的队列中，而不同的就绪队列采用不同的调度算法。

**多级反馈队列调度算法**

 

## 4.2 进程死锁

### 4.2.1 死锁的原因和条件

#### **死锁的原因**

**竞争资源引起死锁：**不可抢占的资源分配后不能强行收回，只能等待进程用完之后自动释放

**进程推进顺序不当引起死锁**：有些推进顺序引起进程无限期地等待永远不会发生的条件而不能向前推进

#### **产生死锁的必要条件**

**互斥条件：**一个资源一次只能被一个进程所使用（排他性使用）

**不可抢占条件**：一个资源仅能被占有它的进程释放，而不能被别的进程强占

**请求和保持条件：**进程已经保持了至少一个资源，但又提出了新的资源要求，而该资源已经被其他进程占有

**环路等待条件**：当每类资源只有一个时，在发生死锁时，必然存在一个进程-资源的环形链

#### **处理死锁的基本方法**

**死锁的预防**：进程执行前采取某些措施，通过设置某些限制条件，破坏四个必要条件之一

**死锁的避免**：在进程申请资源时用某种方法去防止系统进入不安全状态

**死锁的检测和解除**：通过系统设置的检测机构及时检测死锁的发生，如检测到死锁，则采用撤销进程等死锁解除方法使系统正常工作

 

### 4.2.2 死锁的预防

**破坏互斥条件**：改变资源本身属性

**破坏不可抢占条件**：抢占式调度法主要用于处理机和存储器资源调度，其状态容易保存和恢复

**破坏请求和保持条件**——简单，易于实现，安全，资源利用率低，进程延迟运行

**破坏循环等待条件**：

有序资源使用——将所有的资源按类型进行线性排队

资源按级分配——把资源递增排序成若干等级，要求进程在获取低级资源之后才能获取高级资源

 

### 4.2.3 死锁的避免

进程动态地申请资源，系统进行资源分配之前，先计算资源分配的安全性，若此次分配不会导致系统从安全状态向不安全状态转换，便可将资源分配给进程，否则不分配资源，进程必须阻塞等待，从而避免发生死锁

**系统安全状态：**

系统的一种状态，在此状态开始系统能按某种顺序来为各个进程分配其所需资源，直到最大需求。这个序列称为安全序列，安全序列可能不止一个，若不存在安全序列，则称系统处于不安全状态。

**安全状态向不安全状态的转换：**

如果系统不按安全序列进行分配，可能会导致系统进入不安全状态

 

### 4.2.4 死锁的检测

采用资源分配图的简化判断是否发生了不安全状态。如发现系统处于不安全状态时，即执行死锁解除的策略，采用此法开销相对减少

**资源分配图的简化**

在资源分配图中找一个既不阻塞也非孤立的进程结点（既无已分配的资源也不需申请资源的结点为孤立结点），让其获得全部所需资源而继续运行直至完毕，再释放其所拥有的资源，使其称为孤立结点，若所有的结点经过以上简化都是孤立结点，则该分配图是可完全简化的。

**死锁定理**

S为死锁的充分条件是：当且仅当S状态的资源分配图是不可完全简化的

 

### 4.2.5 死锁的解除

强制地从系统中撤销一个或多个死锁的进程以断开循环等待链

```
撤销全部的死锁进程——开销大
逐个撤销死锁的进程直至死锁环路消除
```

使用一个有效的挂起和解除机构来挂起一些死锁的进程

